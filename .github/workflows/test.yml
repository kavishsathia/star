name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build alloc module
        run: cd alloc && cargo build --target wasm32-unknown-unknown --release

      - name: Build dalloc module
        run: cd dalloc && cargo build --target wasm32-unknown-unknown --release

      - name: Build shadow module
        run: cd shadow && cargo build --target wasm32-unknown-unknown --release

      - name: Run integration tests
        run: cargo test --test integration

      - name: Build compiler to WASM
        run: cargo build --lib --target wasm32-unknown-unknown --release

      - name: Copy WASM files to online/public/wasm
        run: |
          mkdir -p online/public/wasm
          cp target/wasm32-unknown-unknown/release/star.wasm online/public/wasm/compiler.wasm
          cp alloc/target/wasm32-unknown-unknown/release/alloc.wasm online/public/wasm/
          cp dalloc/target/wasm32-unknown-unknown/release/dalloc.wasm online/public/wasm/
          cp shadow/target/wasm32-unknown-unknown/release/shadow.wasm online/public/wasm/

      - name: Commit WASM files
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add online/public/wasm/
          git diff --staged --quiet || git commit -m "Auto: Update compiled WASM files"
          git push
